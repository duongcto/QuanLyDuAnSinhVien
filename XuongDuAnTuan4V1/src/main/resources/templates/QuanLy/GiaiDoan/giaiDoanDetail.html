<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Chi tiết Giai đoạn</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        .modal-gd {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal-content-gd {
            background: #fff;
            border-radius: 12px;
            width: 900px;
            max-width: 98vw;
            max-height: 95vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            padding: 32px 24px 24px 24px;
            position: relative;
            display: flex;
            gap: 32px;
        }
        .close-btn-gd {
            position: absolute;
            top: 18px;
            right: 24px;
            font-size: 28px;
            color: #888;
            cursor: pointer;
        }
        .gd-main {
            flex: 2;
        }
        .gd-side {
            flex: 1;
            min-width: 220px;
        }
        .gd-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 12px;
        }
        .gd-btn-group button {
            margin-right: 8px;
            margin-bottom: 8px;
        }
        .gd-label {
            font-weight: 600;
            margin-top: 18px;
            margin-bottom: 6px;
        }
        .gd-checklist {
            margin-bottom: 18px;
        }
        .gd-checklist-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        .gd-comment-box {
            margin-bottom: 18px;
        }
        .gd-activity {
            font-size: 0.95rem;
            color: #666;
        }
        .gd-side .list-group-item {
            cursor: pointer;
            transition: background 0.15s;
        }
        .gd-side .list-group-item:hover {
            background: #f4f5f7;
        }
        .popup-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 3000;
            display: none;
        }
        .popup-content {
            position: fixed;
            top: 50%; left: 50%; transform: translate(-50%,-50%);
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.18);
            z-index: 3001;
            padding: 24px;
            min-width: 260px;
            display: none;
        }
    </style>
</head>
<body>
<div id="giaiDoanModal" class="modal-gd" style="display: none;">
    <div class="modal-content-gd">
        <span class="close-btn-gd" onclick="GiaiDoanDetail.closeModal()">&times;</span>
        <div class="gd-main">
            <div class="gd-title" id="gdTitle">Code giao diện</div>
            <div class="gd-btn-group mb-2">
                <span id="gdLabels"></span>
                <button class="btn btn-outline-secondary btn-sm" onclick="GiaiDoanDetail.openLabelPopup()">+ Nhãn</button>
                <span id="gdMembers"></span>
                <button class="btn btn-outline-secondary btn-sm" onclick="GiaiDoanDetail.openMemberPopup()">+ Thành viên</button>
                <span id="gdDueDate"></span>
                <button class="btn btn-outline-secondary btn-sm" onclick="GiaiDoanDetail.openDueDatePopup()">+ Ngày hết hạn</button>
                <span class="badge bg-secondary" id="priorityBadge">Độ ưu tiên: Thấp</span>
            </div>
            <div class="gd-label">Mô tả</div>
            <textarea class="form-control mb-2" id="gdDesc" rows="2" placeholder="Thêm mô tả..."></textarea>
            <div class="gd-label"><input type="checkbox" checked disabled> Những việc cần làm</div>
            <div class="progress mb-2" style="height: 8px;">
                <div class="progress-bar" id="gdProgress" style="width: 0%;"></div>
            </div>
            <div class="gd-checklist" id="gdChecklist">
                <!-- Checklist items sẽ được render ở đây -->
            </div>
            <div class="input-group mb-2">
                <input type="text" class="form-control" id="gdChecklistInput" placeholder="Thêm việc cần làm...">
                <button class="btn btn-primary" onclick="GiaiDoanDetail.addChecklistItem()">+ Thêm</button>
            </div>
            <div class="gd-label"><i class="bi bi-chat-left-text"></i> Bình luận</div>
            <div class="gd-comment-box">
                <textarea class="form-control mb-2" id="gdCommentInput" rows="2" placeholder="Viết bình luận... nhập @ để nhắc tới ai đó"></textarea>
                <button class="btn btn-outline-secondary btn-sm" onclick="GiaiDoanDetail.addComment()">Gửi</button>
            </div>
            <div id="gdComments"></div>
            <div class="gd-label"><i class="bi bi-clock-history"></i> Hoạt động</div>
            <div class="gd-activity" id="gdActivity">Xem đầy đủ</div>
        </div>
        <div class="gd-side">
            <div class="list-group">
                <div class="list-group-item" onclick="GiaiDoanDetail.openPriorityPopup()">Độ ưu tiên</div>
                <div class="list-group-item">Thành viên</div>
                <div class="list-group-item">Kiểu công việc</div>
                <div class="list-group-item">Nhãn</div>
                <div class="list-group-item">Ngày hạn</div>
                <div class="list-group-item">Tải ảnh lên</div>
                <div class="list-group-item">Link đính kèm</div>
            </div>
        </div>
    </div>
</div>

<!-- Popup chọn độ ưu tiên -->
<div class="popup-overlay" id="priorityOverlay"></div>
<div class="popup-content" id="priorityPopup">
    <h5>Chọn độ ưu tiên</h5>
    <div class="d-flex flex-column gap-2">
        <button class="btn btn-outline-danger" onclick="GiaiDoanDetail.setPriority('Cao')">Cao</button>
        <button class="btn btn-outline-warning" onclick="GiaiDoanDetail.setPriority('Trung bình')">Trung bình</button>
        <button class="btn btn-outline-secondary" onclick="GiaiDoanDetail.setPriority('Thấp')">Thấp</button>
    </div>
    <button class="btn btn-link mt-3" onclick="GiaiDoanDetail.closePriorityPopup()">Đóng</button>
</div>

<!-- Popup nhập nhãn dán -->
<div class="popup-overlay" id="labelOverlay"></div>
<div class="popup-content" id="labelPopup">
    <h5>Thêm nhãn dán</h5>
    <input type="text" class="form-control mb-2" id="labelInput" placeholder="Tên nhãn...">
    <button class="btn btn-primary" onclick="GiaiDoanDetail.addLabel()">Thêm</button>
    <button class="btn btn-link" onclick="GiaiDoanDetail.closeLabelPopup()">Đóng</button>
</div>

<!-- Popup nhập thành viên -->
<div class="popup-overlay" id="memberOverlay"></div>
<div class="popup-content" id="memberPopup">
    <h5>Thêm thành viên</h5>
    <input type="text" class="form-control mb-2" id="memberInput" placeholder="Tên thành viên...">
    <button class="btn btn-primary" onclick="GiaiDoanDetail.addMember()">Thêm</button>
    <button class="btn btn-link" onclick="GiaiDoanDetail.closeMemberPopup()">Đóng</button>
</div>

<!-- Popup chọn ngày hết hạn -->
<div class="popup-overlay" id="dueDateOverlay"></div>
<div class="popup-content" id="dueDatePopup">
    <h5>Chọn ngày hết hạn</h5>
    <input type="date" class="form-control mb-2" id="dueDateInput">
    <button class="btn btn-primary" onclick="GiaiDoanDetail.setDueDate()">Xác nhận</button>
    <button class="btn btn-link" onclick="GiaiDoanDetail.closeDueDatePopup()">Đóng</button>
</div>

<script>
// Namespace để tránh xung đột
var GiaiDoanDetail = (function() {
    var checklist = [];
    var comments = [];
    var priority = 'Thấp';
    var labels = [];
    var members = [];
    var dueDate = '';

    function getElement(id) {
        return document.getElementById(id);
    }

    function showPopup(popupId, overlayId) {
        var popup = getElement(popupId);
        var overlay = getElement(overlayId);
        if (popup) popup.style.display = 'block';
        if (overlay) overlay.style.display = 'block';
    }

    function hidePopup(popupId, overlayId) {
        var popup = getElement(popupId);
        var overlay = getElement(overlayId);
        if (popup) popup.style.display = 'none';
        if (overlay) overlay.style.display = 'none';
    }

    return {
        openModal: function(title) {
            var titleEl = getElement('gdTitle');
            var modalEl = getElement('giaiDoanModal');
            
            if (titleEl) titleEl.innerText = title || 'Code giao diện';
            if (modalEl) modalEl.style.display = 'flex';
            
            this.renderChecklist();
            this.renderComments();
            this.renderLabels();
            this.renderMembers();
            this.renderDueDate();
        },

        closeModal: function() {
            var modalEl = getElement('giaiDoanModal');
            if (modalEl) modalEl.style.display = 'none';
        },

        addChecklistItem: function() {
            var input = getElement('gdChecklistInput');
            if (!input) return;
            
            var value = input.value.trim();
            if (value) {
                checklist.push({ text: value, done: false });
                input.value = '';
                this.renderChecklist();
            }
        },

        toggleChecklistItem: function(idx) {
            if (checklist[idx]) {
                checklist[idx].done = !checklist[idx].done;
                this.renderChecklist();
            }
        },

        removeChecklistItem: function(idx) {
            if (checklist[idx]) {
                checklist.splice(idx, 1);
                this.renderChecklist();
            }
        },

        renderChecklist: function() {
            var container = getElement('gdChecklist');
            var progressEl = getElement('gdProgress');
            
            if (!container) return;
            
            container.innerHTML = '';
            var doneCount = 0;
            
            for (var i = 0; i < checklist.length; i++) {
                var item = checklist[i];
                if (item.done) doneCount++;
                
                var div = document.createElement('div');
                div.className = 'gd-checklist-item';
                div.innerHTML = '<input type="checkbox" ' + (item.done ? 'checked' : '') + ' onclick="GiaiDoanDetail.toggleChecklistItem(' + i + ')">' +
                    '<span style="' + (item.done ? 'text-decoration:line-through;color:#888;' : '') + '">' + item.text + '</span>' +
                    '<button class="btn btn-sm btn-outline-danger" onclick="GiaiDoanDetail.removeChecklistItem(' + i + ')">&times;</button>';
                container.appendChild(div);
            }
            
            if (progressEl) {
                var percent = checklist.length ? Math.round((doneCount / checklist.length) * 100) : 0;
                progressEl.style.width = percent + '%';
            }
        },

        addComment: function() {
            var input = getElement('gdCommentInput');
            if (!input) return;
            
            var value = input.value.trim();
            if (value) {
                comments.push({ text: value, time: new Date().toLocaleString() });
                input.value = '';
                this.renderComments();
            }
        },

        renderComments: function() {
            var container = getElement('gdComments');
            if (!container) return;
            
            container.innerHTML = '';
            for (var i = 0; i < comments.length; i++) {
                var c = comments[i];
                var div = document.createElement('div');
                div.className = 'mb-2';
                div.innerHTML = '<div><b>Người dùng</b> <span style="color:#888;font-size:0.9em;">' + c.time + '</span></div><div>' + c.text + '</div>';
                container.appendChild(div);
            }
        },

        openPriorityPopup: function() {
            showPopup('priorityPopup', 'priorityOverlay');
        },

        closePriorityPopup: function() {
            hidePopup('priorityPopup', 'priorityOverlay');
        },

        setPriority: function(val) {
            priority = val;
            var badge = document.querySelector('.badge.bg-secondary');
            if (badge) badge.innerText = 'Độ ưu tiên: ' + val;
            this.closePriorityPopup();
        },

        openLabelPopup: function() {
            showPopup('labelPopup', 'labelOverlay');
        },

        closeLabelPopup: function() {
            hidePopup('labelPopup', 'labelOverlay');
        },

        addLabel: function() {
            var input = getElement('labelInput');
            if (!input) return;
            
            var val = input.value.trim();
            if (val) {
                labels.push(val);
                this.renderLabels();
                input.value = '';
                this.closeLabelPopup();
            }
        },

        renderLabels: function() {
            var el = getElement('gdLabels');
            if (!el) return;
            
            var html = '';
            for (var i = 0; i < labels.length; i++) {
                html += '<span class="badge bg-info text-dark me-1">' + labels[i] + '</span>';
            }
            el.innerHTML = html;
        },

        openMemberPopup: function() {
            showPopup('memberPopup', 'memberOverlay');
        },

        closeMemberPopup: function() {
            hidePopup('memberPopup', 'memberOverlay');
        },

        addMember: function() {
            var input = getElement('memberInput');
            if (!input) return;
            
            var val = input.value.trim();
            if (val) {
                members.push(val);
                this.renderMembers();
                input.value = '';
                this.closeMemberPopup();
            }
        },

        renderMembers: function() {
            var el = getElement('gdMembers');
            if (!el) return;
            
            var html = '';
            for (var i = 0; i < members.length; i++) {
                html += '<span class="badge bg-secondary me-1">' + members[i] + '</span>';
            }
            el.innerHTML = html;
        },

        openDueDatePopup: function() {
            showPopup('dueDatePopup', 'dueDateOverlay');
        },

        closeDueDatePopup: function() {
            hidePopup('dueDatePopup', 'dueDateOverlay');
        },

        setDueDate: function() {
            var input = getElement('dueDateInput');
            if (!input) return;
            
            var val = input.value;
            if (val) {
                dueDate = val;
                this.renderDueDate();
                this.closeDueDatePopup();
            }
        },

        renderDueDate: function() {
            var el = getElement('gdDueDate');
            if (!el) return;
            
            el.innerHTML = dueDate ? '<span class="badge bg-warning text-dark me-1">' + dueDate + '</span>' : '';
        }
    };
})();

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Đóng popup khi click overlay
    var overlays = ['priorityOverlay', 'labelOverlay', 'memberOverlay', 'dueDateOverlay'];
    for (var i = 0; i < overlays.length; i++) {
        var overlay = document.getElementById(overlays[i]);
        if (overlay) {
            overlay.addEventListener('click', function() {
                var popupId = this.id.replace('Overlay', 'Popup');
                var popup = document.getElementById(popupId);
                if (popup) {
                    popup.style.display = 'none';
                    this.style.display = 'none';
                }
            });
        }
    }

    // Đóng modal khi click bên ngoài
    var modal = document.getElementById('giaiDoanModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                GiaiDoanDetail.closeModal();
            }
        });
    }
});

// Global function để mở modal từ bên ngoài
function openGiaiDoanModal(title) {
    GiaiDoanDetail.openModal(title);
}
</script>
</body>
</html> 